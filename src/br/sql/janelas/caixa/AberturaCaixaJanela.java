package br.sql.janelas.caixa;

import br.sql.acesso.SQLDatabaseConnection;
import br.sql.bean.JsysParametros;
import br.sql.bean.JsysTranferenciaEntreContas;
import br.sql.log.Log;
import br.sql.util.ManagerData;
import br.sql.util.ManagerDecimal;
import br.sql.util.Retorna;
import java.awt.event.KeyEvent;
import java.util.HashMap;
import java.util.Map;
import javax.persistence.RollbackException;
import javax.swing.JOptionPane;
import jsys.sql.Menu;

/**
 *
 * @author Juliano Alves Medina
 */
public class AberturaCaixaJanela extends javax.swing.JDialog {

    private static final SQLDatabaseConnection DADOS = new SQLDatabaseConnection();
    /**
     * Creates new form AberturaCaixaJanela
     *
     * @param parent
     * @param modal
     */
    public AberturaCaixaJanela(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        setTitle("Abertura de Caixa");
        initComponents();
        jTextFieldValorAbertura.requestFocus();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jButtonCancela = new javax.swing.JButton();
        jButtonConfirma = new javax.swing.JButton();
        jLabel2 = new javax.swing.JLabel();
        jTextFieldcaixa = new javax.swing.JTextField();
        jLabel3 = new javax.swing.JLabel();
        jTextFieldValorAbertura = new javax.swing.JTextField();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        jPanel1.setBackground(new java.awt.Color(255, 255, 255));

        jLabel1.setFont(new java.awt.Font("Tahoma", 0, 18)); // NOI18N
        jLabel1.setText("Abertura de Caixa");
        jLabel1.setToolTipText("");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jLabel1)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, 50, Short.MAX_VALUE)
        );

        jButtonCancela.setText("Cancelar");
        jButtonCancela.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonCancelaActionPerformed(evt);
            }
        });

        jButtonConfirma.setText("Confirmar");
        jButtonConfirma.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonConfirmaActionPerformed(evt);
            }
        });

        jLabel2.setText("Caixa:");

        jTextFieldcaixa.setEditable(false);
        jTextFieldcaixa.setBackground(new java.awt.Color(255, 255, 204));
        jTextFieldcaixa.setText(Menu.getIdBanco().toString() + " - " + Menu.getNomeBanco());
        jTextFieldcaixa.setToolTipText("");

        jLabel3.setText("Valor");

        jTextFieldValorAbertura.setDocument(new br.sql.plainDocument.MoedaDocument(15));
        jTextFieldValorAbertura.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jTextFieldValorAbertura.setToolTipText("");
        jTextFieldValorAbertura.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyPressed(java.awt.event.KeyEvent evt) {
                jTextFieldValorAberturaKeyPressed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(jPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jLabel2)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jTextFieldcaixa))
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jLabel3)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(jTextFieldValorAbertura, javax.swing.GroupLayout.PREFERRED_SIZE, 139, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 65, Short.MAX_VALUE)
                        .addComponent(jButtonConfirma)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(jButtonCancela)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(jTextFieldcaixa, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jButtonCancela)
                        .addComponent(jButtonConfirma))
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel3)
                        .addComponent(jTextFieldValorAbertura, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void jButtonConfirmaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonConfirmaActionPerformed
        lancaAberturaCaixa();
        this.dispose();
    }//GEN-LAST:event_jButtonConfirmaActionPerformed

    private void jButtonCancelaActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonCancelaActionPerformed
        this.dispose();
    }//GEN-LAST:event_jButtonCancelaActionPerformed

    private void jTextFieldValorAberturaKeyPressed(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_jTextFieldValorAberturaKeyPressed
        if (evt.getKeyCode() == KeyEvent.VK_ENTER) {
            jButtonConfirma.doClick();
        }
    }//GEN-LAST:event_jTextFieldValorAberturaKeyPressed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButtonCancela;
    private javax.swing.JButton jButtonConfirma;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JTextField jTextFieldValorAbertura;
    private javax.swing.JTextField jTextFieldcaixa;
    // End of variables declaration//GEN-END:variables

    private void lancaAberturaCaixa() {
        JsysParametros par = Retorna.JsysParametros();
        try {
            Map<Object, Object> filtro = new HashMap<>();
            filtro.put("data", ManagerData.getDataAtualTypeDate(ManagerData.INICIO));
            filtro.put("idBancoDestino", Retorna.jsysClientes(Menu.getIdBanco()));
            filtro.put("idGeral", par.getIdGeralAberturaCaixa());
            JsysTranferenciaEntreContas T = (JsysTranferenciaEntreContas) Retorna.findOneResult("JsysTranferenciaEntreContas.findByAberturaDodia", filtro);
            if (T != null) {
                String valorAnterior = ManagerDecimal.converter(T.getValor());
                T.setValor(ManagerDecimal.StringToBigDecimal(jTextFieldValorAbertura.getText()));
                T.setUsuarioAlteracao(Menu.getNomeUsuario());
                T.setDataAlteracao(ManagerData.getDate());
                br.sql.acesso.ConnectionFactory.update(T);
                StringBuilder script = new StringBuilder();
                script.append("RegistraLiberacao('JsysTranferenciaEntreContas', ")
                        .append("'").append(T.getId()).append("', ")
                        .append("'").append("O Caixa foi aberto com o Saldo de ").append(valorAnterior).append("', ")
                        .append("'").append(Menu.getNomeUsuario()).append("', ")
                        .append("'Caixa Reabertura', ")
                        .append("'").append(Menu.getNomeUsuario()).append("') ");
                DADOS.execProcedure(script);
                JOptionPane.showMessageDialog(null, "Abertura de Caixa Foi Alterada com Sucesso", "Confirma", JOptionPane.INFORMATION_MESSAGE);
            } else {
                T = new JsysTranferenciaEntreContas();
                T.setIdGeral(par.getIdGeralAberturaCaixa());
                T.setValor(ManagerDecimal.StringToBigDecimal(jTextFieldValorAbertura.getText()));
                T.setData(ManagerData.getDataAtualTypeDate(ManagerData.INICIO));
                T.setDescricao("");
                T.setIdBancoOrigem(Retorna.jsysClientes(par.getIdBancoCofre()));
                T.setIdBancoDestino(Retorna.jsysClientes(Menu.getIdBanco()));
                T.setCancelada(false);
                T.setIdTitulo(par.getIdTituloDinhero());
                T.setDataInclusao(ManagerData.getDate());
                T.setUsuarioInclusao(Menu.getNomeUsuario());
                T.setRetirado(false);
                br.sql.acesso.ConnectionFactory.insert(T);
                JOptionPane.showMessageDialog(null, "Abertura de Caixa Realizada com Sucesso", "Confirma", JOptionPane.INFORMATION_MESSAGE);
            }
        } catch (RollbackException e) {
            Log.registraErro(this, "lancaAberturaCaixa", e);
            JOptionPane.showMessageDialog(this, "Erro inesperado não Foi Possível Realizar a Abertura de Caixa", "Erro", JOptionPane.ERROR_MESSAGE);
        }
    }
}
